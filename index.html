<!doctype html>
<html lang="zh-CN">
<meta charset="utf-8">
<title>批量转 WebP 并打包下载</title>
<body>
  <input type="file" id="file" accept="image/*" multiple>
  <label>
    品质：
    <input type="number" id="q" min="1" max="100" value="90">
  </label>
  <br><br>
  <div id="progress" style="margin-bottom:8px;"></div>
  <button id="run">开始压缩</button>
  <pre id="log" style="border:1px solid #ccc; padding:8px; height:500px; overflow:auto;font-size: 20px;"></pre>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    const fileInput = document.getElementById('file');
    const qInput = document.getElementById('q');
    const runBtn = document.getElementById('run');
    const progressDiv = document.getElementById('progress');
    const logDiv = document.getElementById('log');

    const fmtSize = n => n > 1024*1024 ? (n/1048576).toFixed(2)+' MB' : (n/1024).toFixed(2)+' KB';

    runBtn.addEventListener('click', async () => {
      if (!fileInput.files.length) return alert('请选择图片');
      runBtn.disabled = true;
      progressDiv.textContent = '准备开始...';
      logDiv.textContent = '';

      const qVal = Math.max(1, Math.min(100, +qInput.value || 90));
      const quality = qVal / 100;
      const zip = new JSZip();
      const files = Array.from(fileInput.files);

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        progressDiv.textContent = `压缩中：${i + 1} / ${files.length}`;

        const bitmap = await createImageBitmap(file);
        const canvas = document.createElement('canvas');
        canvas.width = bitmap.width;
        canvas.height = bitmap.height;
        canvas.getContext('2d').drawImage(bitmap, 0, 0);
        bitmap.close();

        const blob = await new Promise(r => canvas.toBlob(r, 'image/webp', quality));
        const arrayBuffer = await blob.arrayBuffer();

        // 保留原文件名，只改扩展名
        const newName = file.name.replace(/\.[^.]+$/, '.webp');
        if (files.length === 1) {
          // 单张图片直接下载
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = file.name.replace(/\.[^.]+$/, '.webp');
          a.click();
          URL.revokeObjectURL(a.href);
        } else {
          // 多张图片打包 ZIP
          zip.file(newName, arrayBuffer);
        }


        // 输出压缩前后大小
        logDiv.textContent += `${file.name}: ${fmtSize(file.size)} → ${fmtSize(blob.size)}\n`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      if (files.length > 1) {
        progressDiv.textContent = '正在打包 ZIP...';
        const zipBlob = await zip.generateAsync({ type: 'blob' });
      
        const a = document.createElement('a');
        a.href = URL.createObjectURL(zipBlob);
        a.download = `Webp压缩-品质${qVal}.zip`;
        a.click();
        URL.revokeObjectURL(a.href);
      }

      progressDiv.textContent = '完成！';
      runBtn.disabled = false;
    });
  </script>
</body>
</html>


