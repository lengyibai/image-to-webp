<!doctype html>
<html lang="zh-CN">
<meta charset="utf-8">
<title>图片批量转 WebP 并打包下载</title>
<body>
  <input type="file" id="file" accept="image/*" multiple>
  <label>
    品质：
    <input type="number" id="q" min="1" max="100" value="75">
  </label>
  <br><br>
  <div id="progress" style="margin-bottom:8px;"></div>
  <button id="run">开始压缩</button>

  <script src="./jszip.min.js"></script>
  <script>
    const fileInput = document.getElementById('file');
    const qInput = document.getElementById('q');
    const runBtn = document.getElementById('run');
    const progressDiv = document.getElementById('progress');

    runBtn.addEventListener('click', async () => {
      if (!fileInput.files.length) return alert('请选择图片');
      runBtn.disabled = true;
      progressDiv.textContent = '准备开始...';

      const qVal = Math.max(1, Math.min(100, +qInput.value || 75));
      const quality = qVal / 100;
      const zip = new JSZip();
      const files = Array.from(fileInput.files);

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        progressDiv.textContent = `压缩中：${i + 1} / ${files.length}`;

        const bitmap = await createImageBitmap(file);
        const canvas = document.createElement('canvas');
        canvas.width = bitmap.width;
        canvas.height = bitmap.height;
        canvas.getContext('2d').drawImage(bitmap, 0, 0);
        bitmap.close();

        const blob = await new Promise(r => canvas.toBlob(r, 'image/webp', quality));
        const arrayBuffer = await blob.arrayBuffer();

        // 保留原文件名，只改扩展名
        const newName = file.name.replace(/\.[^.]+$/, '.webp');
        zip.file(newName, arrayBuffer);
      }

      progressDiv.textContent = '正在打包 ZIP...';
      const zipBlob = await zip.generateAsync({ type: 'blob' });

      const a = document.createElement('a');
      a.href = URL.createObjectURL(zipBlob);
      a.download = `Webp压缩-品质${qVal}.zip`;
      a.click();
      URL.revokeObjectURL(a.href);

      progressDiv.textContent = '完成！';
      runBtn.disabled = false;
    });
  </script>
</body>
</html>
